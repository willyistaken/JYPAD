name: Build JYPad

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build_macos:
    name: macOS Build
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install JUCE (if not submodule)
        run: |
          if [ ! -d "JUCE" ]; then
            git clone https://github.com/juce-framework/JUCE.git --branch 7.0.9 --depth 1
          fi

      - name: Configure CMake
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64"

      - name: Build
        run: cmake --build build --parallel 4

      - name: Upload Artifacts (AU)
        uses: actions/upload-artifact@v4
        with:
          name: JYPad-macOS-AU
          path: build/PlugDataCustomObject_artefacts/Release/AU/JYPad.component

      - name: Upload Artifacts (VST3)
        uses: actions/upload-artifact@v4
        with:
          name: JYPad-macOS-VST3
          path: build/PlugDataCustomObject_artefacts/Release/VST3/JYPad.vst3

  build_windows:
    name: Windows Build
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install JUCE (if not submodule)
        shell: bash
        run: |
          if [ ! -d "JUCE" ]; then
            git clone https://github.com/juce-framework/JUCE.git --branch 7.0.9 --depth 1
          fi

      - name: Configure CMake
        run: cmake -S . -B build -G "Visual Studio 17 2022" -A x64

      - name: Build
        run: cmake --build build --config Release --parallel 4

      - name: Upload Artifacts (VST3)
        uses: actions/upload-artifact@v4
        with:
          name: JYPad-Windows-VST3
          path: build/PlugDataCustomObject_artefacts/Release/VST3/JYPad.vst3

